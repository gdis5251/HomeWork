# 内存对齐

## 1. 为什么要存在内存对齐

> 大部分参考资料是这么说的

1. **平台原因（移植原因）**：不是所有的硬件平台都能访问任意地址上的任意数据的；某些硬件平台只能在某些地址处取某些特定类型的数据，否则抛出硬件异常。

2. **性能原因**：数据结构（尤其是栈）应该因可能地在自然边界上对齐。原因在于，为了访问未对齐的内存，处理器需要做两次内存访问；而对齐的内存访问仅需要一次访问。

   > 举个例子：
   >
   > 在cpu读取数据的时候，系统默认一次读取n个字节，这里就规定一次读取4个字节。
   >
   > ![QQ截图20181119183323](C:\Users\dell\Desktop\QQ截图20181119183323.png)
   >
   > 现在有一个结构体，有字符型 a 和整形 i 。cpu第一次读取数据，读四个字节，一个字节的a 和 三个字节的i；第二次读取还是读取到4个字节，一个字节的i和三个空字节；第三步cpu将拼接i的三个字节和一个字节。这个过程就显得非常的麻烦。所以我们要内存对齐。 
   >
   > 

总体来说：

> 结构体的内存对齐是拿空间来换取时间的做法。

所以我们在设计结构体的时候就应该满足：

> 让占用空间小的成员尽量集中在一起。



## 2. 怎么进行内存对齐：

1. 第一个成员在与结构体变量偏移量为0的地址处。

   > 我们给结构体开辟空间的时候，默认第一个元素不需要对齐，直接放。

2. 其他成员变量要**对齐到**某个数字（对齐数）的整数倍的地址处。

  > 对齐到指存放该变量的起始偏移量能够整除该变量的对齐数。
  >
  > 通常是能整除该对齐数的最小整数。

  >偏移量是指当前地址对于起始地址相差的字节数。

  对齐数 = 编译器默认的一个对齐数 与 该成员大小的较小值。 VS中默认的值为8 Linux中的默认值为4。

  > 例如：int类型占4个字节，VS 的默认对齐数为8，取一个较小的，所以int类型的对齐数为4。

3. 结构体总大小为最大对齐数（每个成员变量都有一个对齐数）的整数倍。

   > 最后结构体的大小要扩展到最大对齐数的整数倍。

4.  如果嵌套了结构体的情况，嵌套的结构体对齐到自己的最大对齐数的整数倍处，结构体的整体大小就是所有最大对齐数（含嵌套结构体的对齐数）的整数倍。

   > 一个结构体的对齐数是它内部的最大对齐数。
   >
   > 例如：
   >
   > struct A
   >
   > {
   >
   > ​	char c;
   >
   > ​	int i;
   >
   > ​	double d;
   >
   > };
   >
   > 这个结构体的对齐数就是它内部的最大对齐数double的对齐数为8。



## 3. 简单的练习

```c
#define _CRT_SECURE_NO_WARNINGS 1

#include <stdio.h>
#include <Windows.h>

/*
* 本程序是关系内存对齐的测试
* 郭文峰
* 2018/11/19
*/

struct s1
{
	char c1;	//从起始偏移量为0的位置开始存
	int i;		//从起始偏移量为4的位置开始存
	char c2;	//从起始偏移量为8的位置开始存
};//最后结构体的大小扩展至最大对齐数4的整数倍为12

struct s2
{
	char c1;	//从起始偏移量为0的位置开始存
	char c2;	//从起始偏移量为1的位置开始存
	int i;		//从起始偏移量为4的位置开始存
};//最后结构体的大小扩展至最大对齐数4的整数倍为8

struct s3
{
	double d;	//从起始偏移量为0的位置开始存
	char c;		//从起始偏移量为8的位置开始存
	int i;		//从起始偏移量为12的位置开始存
};//最后结构体的大小扩展至最大对齐数8的整数倍为16

struct s4
{
	char c1;		//从起始偏移量为0的位置开始存
	struct s3 s3;	//从起始偏移量为8的位置开始存
	double d;		//从起始偏移量为24的位置开始存
};//最后结构体的大小扩展至最大对齐数8的整数倍为32

int main(void)
{
	printf("%d\n", sizeof(struct s1));
	printf("%d\n", sizeof(struct s2));
	printf("%d\n", sizeof(struct s3));
	printf("%d\n", sizeof(struct s4));



	system("pause");
	return;
}

```

### 运行结果：

![QQ截图20181119185802](C:\Users\dell\Desktop\QQ截图20181119185802.png)



## 4. 修改默认对齐数

这里修改默认对齐数只需要```#pragma```这个预处理指令即可。

```c
#pragme pack(对齐数) //将对齐数修改为某一特定的值

#pragme pack()		//如果括号内为空，则取消设置的对齐数，还原默认的对齐数
```

结论：

> 结构在对齐方式不合适的时候，我们可以自己更改默认对齐数。